# create-image-OS

## Сборка и запуск
Перед создание образа нужно в ручную создать папку build, которая должна распологаться в одной директории с файлом [entry.sh](./entry.sh)
```
mkdir build
```
Далее нужно активировать скрипт [build.sh](./build.sh) чтобы создать образ
```
./scripts/build.sh
```
Теперь есть возможно создать и запустить контейнер из образа при помощи docker run у которого предусмотрено три возможных аргумента: build|run|bash
```
docker run --rm -it -v ./build:/home/ravendexter/poky/build yocto-test build
docker run --rm -it -v ./build:/home/ravendexter/poky/build yocto-test run
docker run --rm -it -v ./build:/home/ravendexter/poky/build yocto-test bash
```
build - аргумента создаст новый слой helloyadro, создаст исполняемый файл с приветствием и выполнит сборку минимального образа (core-image-minimal). Также это требуется для работы qemu<br/> 
run - аргумента запускает эмулятор qemu без графического интерфейса<br/> 
bash - аргумента открывает интерективную оболочку bash в Докер контейнере, можно убедиться в работе программы helloyadro<br/> 

## Запуск helloyadro
```
docker run --rm -it -v ./build:/home/ravendexter/poky/build yocto-test build
docker run --rm -it -v ./build:/home/ravendexter/poky/build yocto-test bash
cd build/tmp/work/core2-64-poky-linux/helloyadro/1.0-r0/build
./helloyadro
```

## Детали реализации
### Пункт 1
Сначала происхоит переключение на новую ветку my-branch, которая основана на удаленной ветке kirkstone.<br/> 
С помощью команды oe-init-build-env настраиваем окружение для сборки<br/> 
Комнда bitbake core-image-minimal выполняет сборку минимального образа<br/> 
Зайдя в контейнер и введя из папке poky 
```
./scripts/runqemu ./build/tmp/deploy/images/qemux86-64 slirp nographic
```
можно запустить эмулятор qemu. Используется режим slirp для сетевого подключения и nographic для работы без графического интерфейса.<br/> 

### Пункт 2
Создаётся образ на основе Ubuntu 20.04<br/> 
Происходит обновление и установка необходимых библиотек и утелит, а также создаётся локаль en_US.UTF-8<br/> 
Создаётся пользователь чтобы контейнер не работал от пользователя root, что приводит к ошибкам. Пользователь с именем ravendexter и UID/GID, которому предоставляются права sudo без необходимости ввода пароля. Без прав sudo возможны пробелемы при создание слоя в контейнере<br/> 
Далее нужно клонировать репозиторий Yocto Project<br/> 
Также нужно скопировать файл [entry.sh](./entry.sh) в рабочий каталог<br/> 
В конце устанавливается endpoint, тоесть контейнер будет запускаться с исполнением скрипта [entry.sh](./entry.sh)<br/>
#### docker volume
При команде docker run устанавливается том благодаря docker volume, чтобы папка build из контейнера хранилась на хост-машине. Локально данные находятся в папке build о которой 
писалось в разделе "Сборка и запуск". Том устанавливает при помощи флага -v и в нашем случае указываем пути 
```
./build:/home/ravendexter/poky/build
```
Данный подход поможет также проконтролировать корректность создания нового слоя helloyadro.<br/>
#### Аргументы при запуске контейнера
В разделе "Сборка и запуск" описано какие аргументы существуют и для чего они нужны. Реализована обработка аргументов через bash скрипт.<br/> 

### Пункт 3
Весь процесс описан в bash скрипте [entry.sh](./entry.sh).<br/>
#### создание слоя
Создается новый слой meta-mylayer и новый слой добавляется в сборочную сред с помощью команд
```
bitbake-layers create-layer ../meta-mylayer
bitbake-layers add-layer ../meta-mylayer
```
#### создание рецепта
Далее нужно создать рецепт в папке recipes-example, которая находится в папке слоя meta-mylayer. Создаём папку helloyadro, а в ней файл helloyadro.bb
который является файлом рецепта, который описывает сборку программы helloyadro. В этом файле определяются метаданные, такие как лицензия, исходный код и команды для компиляции и установки.<br/>
Также в папке helloyadro создаём папку files, а в ней файл helloyadro.c, который выводит сообщение "Hello from my own program!"<br/><br/>

ps. команды приведённые в пунктах 1,2,3 не считая команд запуска контейнера записаны в [entry.sh](./entry.sh)